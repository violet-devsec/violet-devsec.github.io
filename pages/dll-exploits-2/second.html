<!DOCTYPE HTML>
<!--
	Future Imperfect by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Dll Exploits - II</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="../../assets/css/main.css" />
        <link rel="stylesheet" href="../../assets/css/app.css"/>
        <style>
            .m-hero__picture {
              background-image: url(../../images/dll-exploits-2/dll_exploits_2_bg.jpg);
            }
          
            @media(max-width: 1000px) {
              .m-hero__picture {
                background-image: url(../../images/dll-exploits-2/dll_exploits_2_bg.jpg);
              }
            }
          
            @media(max-width: 600px) {
              .m-hero__picture {
                background-image: url(../../images/dll-exploits-2/dll_exploits_2_bg.jpg);
              }
            }
          </style>
	</head>
	<body class="single is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Header -->
					<header id="header">
						<h1><a href="../../index.html">Violet Devsec</a></h1>
                        <!--
                            <nav class="links">
                                <ul>
                                    <li><a href="#">Lorem</a></li>
                                    <li><a href="#">Ipsum</a></li>
                                    <li><a href="#">Feugiat</a></li>
                                    <li><a href="#">Tempus</a></li>
                                    <li><a href="#">Adipiscing</a></li>
                                </ul>
                            </nav>
                        -->
						<nav class="main">
							<ul>
								<li class="search">
									<a class="fa-search" href="#search">Search</a>
									<form id="search" method="get" action="#">
										<input type="text" name="query" placeholder="Search" />
									</form>
								</li>
								<li class="menu">
									<a class="fa-bars" href="#menu">Menu</a>
								</li>
							</ul>
						</nav>
					</header>

				<!-- Menu -->
					<section id="menu">

						<!-- Search -->
							<section>
								<form class="search" method="get" action="#">
									<input type="text" name="query" placeholder="Search" />
								</form>
							</section>

						<!-- Links -->
							<section>
								<ul class="links">
									<li>
										<a href="#">
											<h3>Lorem ipsum</h3>
											<p>Feugiat tempus veroeros dolor</p>
										</a>
									</li>
									<li>
										<a href="#">
											<h3>Dolor sit amet</h3>
											<p>Sed vitae justo condimentum</p>
										</a>
									</li>
									<li>
										<a href="#">
											<h3>Feugiat veroeros</h3>
											<p>Phasellus sed ultricies mi congue</p>
										</a>
									</li>
									<li>
										<a href="#">
											<h3>Etiam sed consequat</h3>
											<p>Porta lectus amet ultricies</p>
										</a>
									</li>
								</ul>
							</section>

						<!-- Actions -->
							<section>
								<ul class="actions stacked">
									<li><a href="#" class="button large fit">Log In</a></li>
								</ul>
							</section>

					</section>

				<!-- Main -->
					<div id="main">

						<!-- Post -->
							<article class="post">
								<header>
									<div class="title">
										<h2><a href="#">DLL Exploits Part-II : DLL modification and StrongName signing bypass</a></h2>
										<p></p>
									</div>
									<div class="meta">
										<time class="published" datetime="2015-11-01">March 20, 2022</time>
										<a href="#" class="author"><span class="name">Violet Devsec</span><img src="../../images/avatar.jpg" alt="" /></a>
									</div>
								</header>
                                <section class="m-hero with-picture aos-init aos-animate" data-aos="fade">
                                    <div class="m-hero__picture in-post"></div>
                                </section>
                                <!--Post content-->
                                        <div class="l-post-content   js-progress-content">
                                            <div class="pos-relative js-post-content">
                                                <p></p>
                                                <ol start="10">
                                                    <li>
                                                        <strong>A little deeper investigation</strong>
														<p>It is observed that when we strong name the DLLs in Visual Studio, the reference to these DLLs in the Entry EXE adds a public key token value with it. This is making the exception at Entry app when the DLLs are strong named out of Visual Studio. So, we need to modify the Entry App exe also to add these public key token value for new Strong name key.</p>
														<img src="../../images/dll-exploits-2/dll_exploits_2_18.png" alt="" />
														<p>(Fig: Entry App exe's IL code showing reference to backend DLLs. Left side: Strong Named in VS, Right side: Strong named out of VS)</p>
                                                    </li>
                                                    <li>
                                                        <strong>Decompiling the Entry app EXE.</strong>
														<img src="../../images/dll-exploits-2/dll_exploits_2_19.png" alt="" />
                                                    </li>
                                                    <li>
                                                        <strong>Modify publickeytoken value in assembly reference.</strong>
														<p>Modify the existing publickeytoken value with the public key token for new strong name key.</p>
                                                        <img src="../../images/dll-exploits-2/dll_exploits_2_20.png" alt="" />
														<img src="../../images/dll-exploits-2/dll_exploits_2_21.png" alt="" />
                                                    </li>
                                                    <li>
                                                        <strong>Reassemble the IL code back to Exe</strong>
														<p>Recompile the modified IL code to new exe and replace old exe with the new exe in the application folder.</p>
                                                        <img src="../../images/dll-exploits-2/dll_exploits_2_22.png" alt="" />
                                                    </li>
                                                    <li>
                                                        <strong>Application started!</strong>
														<p>Now, application booted up. But, App got halted due to the expected Authenticode signature verification fail.</p>
														<p>Wait a minute! This does not satisfy our initial target. </p>
														<p>We didn't target to modify the Entry Exe app in the attack scenario. Attacker can change the validation logic if he has privilege to modify the Entry Exe. So I have decided to check a bit about this behaviour. I have come to know that this is a feature in .Net Framework called strict loading. .Net CLR will not bind references if there is any mismatch in the StrongName details added during build.</p>
                                                        <img src="../../images/dll-exploits-2/dll_exploits_2_23.png" alt="" />
                                                    </li>
													<li>
                                                        <strong>Changing the UI application to .Net Core</strong>
														<p>So, I have quickly created a Console UI in .Net Core. And, added reference to the MathLib Dll for performing the calculator operations.</p>
                                                        <img src="../../images/dll-exploits-2/dll_exploits_2_24.png" alt="" />
                                                    </li>
													<li>
                                                        <strong>Moved the new UI exe to the DLL modification workspace and started.</strong>
														<p>There is no problem now as it faced in the case of .Net Framework UI. StrongName validation was successful and the UI app throws error for Authenticode signature failure.</p>
                                                        <img src="../../images/dll-exploits-2/dll_exploits_2_26.png" alt="" />
                                                    </li>
													<li>
                                                        <strong>Signed with attacker's Authenticode cert!</strong>
														<p></p>
                                                        <img src="../../images/dll-exploits-2/dll_exploits_2_27.png" alt="" />
                                                    </li>
													<li>
                                                        <strong>Run the application again!</strong>
														<p>Again we get the "Signature verification failed" error. We can now the reason of exception is because of "Untrusted Certificate", if we debug the application with the modified DLL. This means attacker's certificate is not in the Trusted root store of the production machine. So attacker cannot achieve bypassing Authenticode signing. </p>
                                                        <img src="../../images/dll-exploits-2/dll_exploits_2_28.png" alt="" />
														<img src="../../images/dll-exploits-2/dll_exploits_2_29.png" alt="" />
                                                    </li>
													<li>
                                                        <strong>A final confirmation!</strong>
														<p>To just start the App and show the effect of modified DLL, we can sign the DLL with old original certificate. Application started-up and given the modified Dll output.</p>
														<p>This step proves that we can strong name the DLL with a different strong name key. But, Authenticode signing will fail if it is not signed with a certificate which is not in trusted root store.</p>
														<img src="../../images/dll-exploits-2/dll_exploits_2_30.png" alt="" />
														<img src="../../images/dll-exploits-2/dll_exploits_2_31.png" alt="" />
														<p>(Note: Alternatively, we can add the Fake certificate to Trusted root store to start the application. But, it is DANGEROUS to add random certificates to Trusted root store!!)</p>
                                                    </li>
                                                </ol>
                                                <!-- Pagination -->
                                                <ul class="actions pagination">  
                                                    <li><a href="index.html" class="button large previous">Previous Page</a></li>
                                                    <li><a href="second.html" class="disabled button large next" style="position: absolute; right: 0;">Next Page</a></li>
                                                
                                                </ul>
                                            </div>
                                            
                                        </div>
                                         
								<footer>
									<ul class="stats">
										<li><a href="#">General</a></li>
										<li><a href="#" class="icon solid fa-heart">28</a></li>
										<li><a href="#" class="icon solid fa-comment">128</a></li>
									</ul>
								</footer>
							</article>
                           
					</div>

				<!-- Footer -->
					<section id="footer">
						<ul class="icons">
							<li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
							<li><a href="#" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
							<li><a href="#" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
							<li><a href="#" class="icon solid fa-rss"><span class="label">RSS</span></a></li>
							<li><a href="#" class="icon solid fa-envelope"><span class="label">Email</span></a></li>
						</ul>
						<p class="copyright">&copy; Untitled. Design: <a href="http://html5up.net">HTML5 UP</a>. Images: <a href="http://unsplash.com">Unsplash</a>.</p>
					</section>

			</div>

		<!-- Scripts -->
			<script src="../../assets/js/jquery.min.js"></script>
			<script src="../../assets/js/browser.min.js"></script>
			<script src="../../assets/js/breakpoints.min.js"></script>
			<script src="../../assets/js/util.js"></script>
			<script src="../../assets/js/main.js"></script>

	</body>
</html>